name: Build and Release Zapzap

on:
  release:
    types: [created]

jobs:
  build-release:
    runs-on: ubuntu-latest

    env:
      PYTHON_VERSION: '3.13'

    steps:
      # 1ï¸âƒ£ Pegar o cÃ³digo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2ï¸âƒ£ Configurar Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # 3ï¸âƒ£ Instalar ferramentas de build
      - name: Install build tools
        run: |
          python -m pip install --upgrade pip setuptools wheel build

      # 4ï¸âƒ£ Obter versÃ£o da tag
      - name: Get version from tag
        run: echo "VERSION=${GITHUB_REF##*/}" >> $GITHUB_ENV

      # 5ï¸âƒ£ Build do wheel
      - name: Build wheel
        run: python -m build --wheel --outdir dist

      # 6ï¸âƒ£ Conferir arquivos gerados
      - name: List dist folder
        run: ls -l dist/

      # 7ï¸âƒ£ Instalar fpm (para criar .deb)
      - name: Install fpm
        run: |
          sudo apt update
          sudo apt install -y ruby ruby-dev build-essential
          sudo gem install --no-document fpm

      # 8ï¸âƒ£ Preparar arquivos para .deb
      - name: Prepare .deb files
        run: |
          WHEEL_FILE=$(ls dist/*.whl | head -n 1)
          mkdir -p package/usr/share/applications
          mkdir -p package/usr/share/icons/hicolor/scalable/apps

          # Copiar desktop e Ã­cone
          cp share/applications/com.rtosta.zapzap.desktop package/usr/share/applications/
          cp share/icons/com.rtosta.zapzap.svg package/usr/share/icons/hicolor/scalable/apps/

          # Ajustar desktop para comando global
          sed -i 's|Exec=.*|Exec=/usr/bin/zapzap|' package/usr/share/applications/com.rtosta.zapzap.desktop
          sed -i 's|Icon=.*|Icon=com.rtosta.zapzap|' package/usr/share/applications/com.rtosta.zapzap.desktop

          echo "Prepared .desktop and icon for packaging"

      # 9ï¸âƒ£ Build do .deb com fpm (corrigido)
      - name: Build .deb package with fpm
        run: |
          # Encontrar o wheel gerado
          WHEEL_FILE=$(ls dist/*.whl | head -n 1)
          echo "Wheel file: $WHEEL_FILE"

          # Criar diretÃ³rios temporÃ¡rios para .desktop e Ã­cone
          mkdir -p package/usr/share/applications
          mkdir -p package/usr/share/icons/hicolor/scalable/apps

          # Copiar desktop e Ã­cone
          cp share/applications/com.rtosta.zapzap.desktop package/usr/share/applications/
          cp share/icons/com.rtosta.zapzap.svg package/usr/share/icons/hicolor/scalable/apps/

          # Ajustar .desktop para comando global
          sed -i 's|Exec=.*|Exec=/usr/bin/zapzap|' package/usr/share/applications/com.rtosta.zapzap.desktop
          sed -i 's|Icon=.*|Icon=com.rtosta.zapzap|' package/usr/share/applications/com.rtosta.zapzap.desktop

          # Criar arquivo temporÃ¡rio para after-install
          echo 'echo "ZapZap installed successfully"' > after-install.sh
          chmod +x after-install.sh

          # Executar fpm
          fpm -s python -t deb "$WHEEL_FILE" \
            --name zapzap \
            --version "${{ env.VERSION }}" \
            --depends python3-pyqt6 \
            --depends python3-pyqt6-webengine \
            --depends python3-dbus \
            --description "ZapZap â€” WhatsApp client web app" \
            --license "GPL-3.0-or-later" \
            --url "https://rtosta.com/zapzap" \
            --vendor "Rafael Tosta" \
            --maintainer "Rafael Tosta <rafa.ecomp@gmail.com>" \
            --architecture all \
            --prefix=/usr \
            --after-install after-install.sh \
            --directories /usr/bin \
            --directories /usr/share/applications \
            --directories /usr/share/icons/hicolor/scalable/apps \
            --config-files package/usr/share/applications/com.rtosta.zapzap.desktop \
            --config-files package/usr/share/icons/hicolor/scalable/apps/com.rtosta.zapzap.svg

      # ðŸ”Ÿ Criar release no GitHub e anexar arquivos
      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/*.whl
            *.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
